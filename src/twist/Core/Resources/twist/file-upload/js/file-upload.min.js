/**
 * This file is part of TwistPHP.
 *
 * TwistPHP is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * TwistPHP is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with TwistPHP.  If not, see <http://www.gnu.org/licenses/>.
 *
 * @author     Shadow Technologies Ltd. <contact@shadow-technologies.co.uk>
 * @license    https://www.gnu.org/licenses/gpl.html LGPL License
 * @link       https://twistphp.com
 *
 */

!function(e,t){var o=!1,n=function(t,n,r){(o||r===!0)&&e.console&&(e.console[n]?e.console[n](t):e.console.log&&console.log(t))},r=function(e,t){return-1!==e.className.indexOf(t)},u=function(e,t){r(e,t)||(e.className+=" "+t)},a=function(e,t){r(e,t)&&(e.className=e.className.replace(new RegExp("^"+t+"$","g"),"").replace(new RegExp("^"+t+" ","g"),"").replace(new RegExp(" "+t+"$","g"),"").replace(new RegExp(" "+t+" ","g")," "))},l=function(e){for(var t=["B","kB","MB","GB","TB","PB","EB","ZB","YB"],o=0;t[o]&&e>Math.pow(1024,o+1);)o++;return s(e/Math.pow(1024,o),o>1?2:0)+t[o]},s=function(e,t){return t="number"!=typeof t?0:t,0===t?parseInt(Math.round(e*Math.pow(10,t))/Math.pow(10,t)):parseFloat(Math.round(e*Math.pow(10,t))/Math.pow(10,t))},d=function(e,r,s){var d="string"==typeof(new XMLHttpRequest).responseType&&"withCredentials"in new XMLHttpRequest;if(d){var p=new XMLHttpRequest;p.open("GET","/");try{p.responseType="arraybuffer"}catch(i){d=!1}}var c=this;c.acceptExtentions=[],c.acceptRaw=[],c.acceptTypes=[],c.created=(new Date).getTime(),c.cancelUpload=function(e){e.preventDefault(),c.request.abort()},c.clearInput=function(e){e&&e.preventDefault(),c.domInput.value="",c.domInput.value&&(c.domInput.type="text",c.domInput.type="file"),c.hideClear(),c.domPseudo.value="",c.settings.onclear()},c.domCancelUpload=t.getElementById(e+"-cancel"),c.domCancelUploadDisplay=null,c.domClearUpload=t.getElementById(e+"-clear"),c.domCount=t.getElementById(e+"-count"),c.domCountWrapper=t.getElementById(e+"-count-wrapper"),c.domCountWrapperDisplay=null,c.domCountTotal=t.getElementById(e+"-total"),c.domInput=t.getElementById(e),c.domInputDisplay=null,c.domProgress=t.getElementById(e+"-progress"),c.domProgressWrapper=t.getElementById(e+"-progress-wrapper"),c.domPseudo=t.getElementById(e+"-pseudo"),c.hideClear=function(){c.domClearUpload&&(c.domClearUpload.style.display="none",c.domClearUpload.removeEventListener("click",c.clearInput))},c.hideProgress=function(){c.domInput&&(c.domInput.style.display=c.domInputDisplay),c.domProgressWrapper&&(c.domProgressWrapper.style.display="none"),c.domCancelUpload&&c.domCancelUpload.removeEventListener("click",c.cancelUpload)},c.multiple=c.domInput&&c.domInput.hasAttribute("multiple"),c.queue=[],c.queueCount=0,c.queueSize=0,c.queueUploadedCount=0,c.queueUploadedSize=0,c.request=new XMLHttpRequest,c.settings={abortable:!0,clearoncomplete:!0,counter:!0,debug:!1,dragdrop:null,onabort:function(){},onclear:function(){},oncompletefile:function(){},oncompletequeue:function(){},onerror:function(){},onprogress:function(){},onstart:function(){}},c.showClear=function(){c.domClearUpload&&(c.domClearUpload.style.display=this.domInputDisplay,c.domClearUpload.addEventListener("click",c.clearInput))},c.showProgress=function(){c.domInput.style.display="none",c.domProgressWrapper&&(c.domProgressWrapper.style.display=c.domInputDisplay),c.domCancelUpload&&c.domCancelUpload.addEventListener("click",c.cancelUpload)},c.supported=!1,c.uid=e,c.upload=function(e,t){try{if(e){if(t)r=t;else var o=e.target||e.srcElement,r=o.files;c.queue.push.apply(c.queue,r),c.queueCount+=r.length;for(var u=0,a=r.length;a>u;u++)c.queueSize+=parseInt(r[u].size);c.domCountTotal&&(c.domCountTotal.innerText=c.queueCount),n("Added "+r.length+" files to the queue","info")}if(null===c.domCancelUploadDisplay&&(c.domCancelUploadDisplay=c.domCancelUpload.style.display||"inline-block"),null===c.domCountWrapperDisplay&&(c.domCountWrapperDisplay=c.domCountWrapper.style.display||"inline-block"),null===c.domInputDisplay&&(c.domInputDisplay=c.domInput.style.display||"inline-block"),c.queue.length){var s=c.queue[0],d=s.name,p=s.type,i=d.substr(d.lastIndexOf(".")+1),m=parseInt(s.size),g=new FileReader({blob:!0}),f=!c.acceptTypes.length&&!c.acceptExtentions.length;if(!f)for(var q in c.acceptTypes)if(new RegExp("^"+c.acceptTypes[q]+"$","gi").test(p)){f=!0;break}if(!f)for(var y in c.acceptExtentions)if(i===c.acceptExtentions[y]){f=!0;break}f?(c.settings.onstart(s),c.showProgress(),c.domCount&&(c.domCount.innerText=c.queueUploadedCount+1),1===c.queueCount?(c.domProgress&&c.domProgress.removeAttribute("value"),c.domCountWrapper&&(c.domCountWrapper.style.display="none")):c.domCountWrapper&&(c.domCountWrapper.style.display=c.domCountWrapperDisplay),g.addEventListener("load",function(){c.request.onreadystatechange=function(){switch(c.request.status){case 200:if(4==c.request.readyState){n("Uploaded "+d+" ("+l(m)+")"),c.queue.shift(),c.queueUploadedCount++,c.queueUploadedSize+=m;var e=JSON.parse(c.request.responseText);c.queue.length?(c.multiple?c.uploaded.push(e.form_value):c.uploaded=[e.form_value],c.settings.oncompletefile(e,s),c.upload()):(c.hideProgress(),n("Finsihed uploading "+c.queueUploadedCount+" files ("+l(c.queueUploadedSize)+")","info"),c.queueCount=0,c.queueSize=0,c.queueUploadedCount=0,c.queueUploadedSize=0,c.settings.clearoncomplete?(c.clearInput(),c.hideClear()):c.showClear(),c.multiple?c.uploaded.push(e.form_value):c.uploaded=[e.form_value],c.settings.oncompletefile(e,s),c.domPseudo.value=c.uploaded.join(","),c.settings.oncompletequeue())}break;case 403:n("Permission denied","error"),c.queue.shift(),c.queueCount--,c.queueSize--,c.settings.onerror(s),c.queue.length?c.upload():c.hideProgress();break;case 404:n("Invalid function call","error"),c.queue.shift(),c.queueCount--,c.queueSize--,c.settings.onerror(s),c.queue.length?c.upload():c.hideProgress()}},c.request.onprogress=function(e){if(e.lengthComputable){if(c.domProgress){var t=Math.round(e.loaded/e.total*100);c.domProgress.value=t,n(l(e.loaded)+"/"+l(e.total)+" ("+t+"%)")}c.settings.onprogress(s,e.loaded,e.total)}},c.request.upload.onprogress=c.request.onprogress,c.request.addEventListener("load",function(){},!1),c.request.addEventListener("error",function(){c.queue.length&&(c.hideProgress(),c.queue=[],c.queueCount=0,c.queueSize=0,c.queueUploadedCount=0,c.queueUploadedSize=0,c.settings.onerror(s),n("An error occurred","error"))},!1),c.request.addEventListener("abort",function(){c.queue.length&&(c.hideProgress(),c.queue=[],c.queueCount=0,c.queueSize=0,c.queueUploadedCount=0,c.queueUploadedSize=0,c.settings.onabort(s),n("Upload aborted","warning"))},!1),c.request.open("PUT",c.uri,!0),c.request.setRequestHeader("Accept",'"text/plain; charset=iso-8859-1", "Content-Type": "text/plain; charset=iso-8859-1"'),c.request.setRequestHeader("Twist-File",d),c.request.setRequestHeader("Twist-Length",m),c.request.setRequestHeader("Twist-UID",c.uid),c.request.send(g.result)},!1),g.readAsArrayBuffer(s)):(c.queue.shift(),c.domInput.value="",n(d+" ("+p+") is not in the list of allowed types","warn"),c.acceptTypes.length&&n("Allowed MIME types: "+c.acceptTypes.join(", ")),c.acceptExtentions.length&&n("Allowed file extenstions: "+c.acceptExtentions.join(", ")),alert("This file type is not permitted"),c.clearInput())}}catch(h){c.hideProgress(),c.queue=[],c.queueCount=0,c.queueSize=0,c.queueUploadedCount=0,c.queueUploadedSize=0,c.settings.onerror(s),c.settings.onabort(s),n(h,"error")}},c.uploaded=[],c.uri="/"+r.replace(/^\//,"").replace(/\/$/,"");for(var m in s)c.settings[m]=s[m];if(c.multiple&&(c.settings.clearoncomplete=!0),c.domPseudo&&c.domPseudo.value&&""!==c.domPseudo.value&&(c.uploaded=c.domPseudo.value.split(",")||[]),o=c.settings.debug===!0,c.domCountWrapper&&!c.settings.counter&&(c.domCountWrapper.style.display="none"),c.domCancelUpload&&!c.settings.abortable&&(c.domCancelUpload.style.display="none"),c.domClearUpload&&(c.domClearUpload.style.display="none"),c.hideProgress(),null!==c.settings.dragdrop){var g=t.getElementById(c.settings.dragdrop);g&&(g.ondrop=function(e){e.preventDefault(),c.upload(e,e.target.files||e.dataTransfer.files),a(g,"hover"),a(g,"droppable")},g.ondragstart=function(){return u(g,"droppable"),!1},g.ondragover=function(){return u(g,"hover"),!1},g.ondragleave=function(){return a(g,"hover"),!1},g.ondragend=function(){return a(g,"hover"),a(g,"droppable"),!1})}var f=c.domInput?c.domInput.getAttribute("accept"):"";if(f){var q=f.replace(/ /g,"").split(",");if(q.length)for(var y in q)"."===q[y].substr(0,1)?c.acceptExtentions.push(q[y].substr(1)):c.acceptTypes.push(q[y].replace(/\//g,"\\/").replace(/\*/g,".*")),c.acceptRaw.push(q[y])}if(c.domPseudo&&c.domInput&&(c.domPseudo.name=c.domInput.name.replace("[]",""),c.domInput.removeAttribute("name")),!d)return c.hideClear(),c.hideProgress(),n("Your browser does not support AJAX uploading","warn",!0),null;try{return c.domInput&&c.domInput.addEventListener("change",c.upload),c}catch(h){n(h,"error")}};e.TwistUploader=function(e,t,o){return new d(e,t,o)}}(window,document);