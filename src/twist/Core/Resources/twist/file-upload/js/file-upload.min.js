/**
 * This file is part of TwistPHP.
 *
 * TwistPHP is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * TwistPHP is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with TwistPHP.  If not, see <http://www.gnu.org/licenses/>.
 *
 * @author     Shadow Technologies Ltd. <contact@shadow-technologies.co.uk>
 * @license    https://www.gnu.org/licenses/gpl.html LGPL License
 * @link       https://twistphp.com
 *
 */

!function(e,o){var t=!1,n=function(o,n){t&&e.console&&(e.console[n]?e.console[n](o):e.console.log&&console.log(o))},l=function(e){for(var o=["B","kB","MB","GB","TB","PB","EB","ZB","YB"],t=0;o[t]&&e>Math.pow(1024,t+1);)t++;return u(e/Math.pow(1024,t),t>1?2:0)+o[t]},u=function(e,o){return o="number"!=typeof o?0:o,0===o?parseInt(Math.round(e*Math.pow(10,o))/Math.pow(10,o)):parseFloat(Math.round(e*Math.pow(10,o))/Math.pow(10,o))},a=function(e,u,a){var r="string"==typeof(new XMLHttpRequest).responseType&&"withCredentials"in new XMLHttpRequest;if(r){var d=new XMLHttpRequest;d.open("GET","/");try{d.responseType="arraybuffer"}catch(s){r=!1}}if(r)try{var p=this;e="twistupload-"+e,p.accept=[],p.created=(new Date).getTime(),p.cancelUpload=function(e){e.preventDefault(),p.request.abort()},p.clearInput=function(e){e&&e.preventDefault(),p.domInput.value="",p.domInput.value&&(p.domInput.type="text",p.domInput.type="file"),p.hideClear(),p.domPseudo.value="",p.settings.onclear()},p.domCancelUpload=o.getElementById(e+"-cancel"),p.domCancelUploadDisplay=null,p.domClearUpload=o.getElementById(e+"-clear"),p.domClearUploadDisplay=null,p.domCount=o.getElementById(e+"-count"),p.domCountWrapper=o.getElementById(e+"-count-wrapper"),p.domCountWrapperDisplay=null,p.domCountTotal=o.getElementById(e+"-total"),p.domInput=o.getElementById(e),p.domInputDisplay=null,p.domProgress=o.getElementById(e+"-progress"),p.domProgressWrapper=o.getElementById(e+"-progress-wrapper"),p.domPseudo=o.getElementById(e+"-pseudo"),p.hideClear=function(){p.domClearUpload&&(p.domClearUpload.style.display="none",p.domClearUpload.removeEventListener("click",p.clearInput))},p.hideProgress=function(){p.domInput.style.display=p.domInputDisplay,p.domProgressWrapper&&(p.domProgressWrapper.style.display="none"),p.domCancelUpload&&p.domCancelUpload.removeEventListener("click",p.cancelUpload)},p.multiple=p.domInput.hasAttribute("multiple"),p.queue=[],p.queueCount=0,p.queueSize=0,p.queueUploadedCount=0,p.queueUploadedSize=0,p.request=new XMLHttpRequest,p.settings={abortable:!0,clearoncomplete:!0,counter:!0,debug:!1,onabort:function(){},onclear:function(){},oncompletefile:function(){},oncompletequeue:function(){},onerror:function(){},onprogress:function(){},verbose:!1},p.showClear=function(){p.domClearUpload&&(p.domClearUpload.style.display=p.domClearUploadDisplay,p.domClearUpload.addEventListener("click",p.clearInput))},p.showProgress=function(){p.domInput.style.display="none",p.domProgressWrapper&&(p.domProgressWrapper.style.display=this.domInputDisplay),p.domCancelUpload&&p.domCancelUpload.addEventListener("click",p.cancelUpload)},p.uid=e,p.upload=function(e){if(e){var o=e.target||e.srcElement,t=o.files;p.queue.push.apply(p.queue,t),p.queueCount+=t.length;for(var u=0,a=t.length;a>u;u++)p.queueSize+=parseInt(t[u].size);p.domCountTotal&&(p.domCountTotal.innerText=p.queueCount),n("Added "+t.length+" files to the queue","info")}if(null===p.domCancelUploadDisplay&&(p.domCancelUploadDisplay=p.domCancelUpload.style.display||"inline-block"),null===p.domCancelUploadDisplay&&(p.domClearUploadDisplay=p.domClearUpload.style.display||"inline-block"),null===p.domCancelUploadDisplay&&(p.domCountWrapperDisplay=p.domCountWrapper.style.display||"inline-block"),null===p.domCancelUploadDisplay&&(p.domInputDisplay=p.domInput.style.display||"inline-block"),p.queue.length){var r=p.queue[0],d=r.name,s=r.type,i=parseInt(r.size),c=new FileReader({blob:!0}),m=!p.accept.length;if(!m)for(var g in p.accept)if(s.match(new RegExp("^"+p.accept[g]+"$"))){m=!0;break}m?(p.showProgress(),p.domCount&&(p.domCount.innerText=p.queueUploadedCount+1),1===p.queueCount?(p.domProgress&&p.domProgress.removeAttribute("value"),p.domCountWrapper&&(p.domCountWrapper.style.display="none")):p.domCountWrapper&&(p.domCountWrapper.style.display=p.domCountWrapperDisplay),c.addEventListener("load",function(){p.request.onreadystatechange=function(){switch(p.request.status){case 200:if(4==p.request.readyState){n("Uploaded "+d+" ("+l(i)+")"),p.queue.shift(),p.queueUploadedCount++,p.queueUploadedSize+=i;var e=JSON.parse(p.request.responseText);p.queue.length?(p.uploaded.push(e.form_value),p.settings.oncompletefile(r,e),p.upload()):(p.hideProgress(),n("Finsihed uploading "+p.queueUploadedCount+" files ("+l(p.queueUploadedSize)+")","info"),p.queueCount=0,p.queueSize=0,p.queueUploadedCount=0,p.queueUploadedSize=0,p.settings.clearoncomplete?(p.clearInput(),p.hideClear()):p.showClear(),p.uploaded.push(e.form_value),p.settings.oncompletefile(r,e),p.domPseudo.value=p.uploaded.join(","),p.settings.oncompletequeue())}break;case 403:n("Permission denied","error"),p.queue.shift(),p.queueCount--,p.queueSize--,p.settings.onerror(r),p.queue.length?p.upload():p.hideProgress();break;case 404:n("Invalid function call","error"),p.queue.shift(),p.queueCount--,p.queueSize--,p.settings.onerror(r),p.queue.length?p.upload():p.hideProgress()}},p.request.onprogress=function(e){if(e.lengthComputable){if(p.domProgress){var o=Math.round(e.loaded/e.total*100);p.domProgress.value=o,p.settings.verbose&&n(l(e.loaded)+"/"+l(e.total)+" ("+o+"%)")}p.settings.onprogress(r,e.loaded,e.total)}},p.request.upload.onprogress=p.request.onprogress,p.request.addEventListener("load",function(){},!1),p.request.addEventListener("error",function(){p.queue.length&&(p.hideProgress(),p.queue=[],p.queueCount=0,p.queueSize=0,p.queueUploadedCount=0,p.queueUploadedSize=0,p.settings.onerror(r),n("An error occurred","error"))},!1),p.request.addEventListener("abort",function(){p.queue.length&&(p.hideProgress(),p.queue=[],p.queueCount=0,p.queueSize=0,p.queueUploadedCount=0,p.queueUploadedSize=0,p.settings.onabort(r),n("Upload aborted","warning"))},!1),p.request.open("PUT",p.uri,!0),p.request.setRequestHeader("Accept",'"text/plain; charset=iso-8859-1", "Content-Type": "text/plain; charset=iso-8859-1"'),p.request.setRequestHeader("Twist-File",d),p.request.setRequestHeader("Twist-Length",i),p.request.setRequestHeader("Twist-UID",p.uid),p.request.send(c.result)},!1),c.readAsArrayBuffer(r)):(n(s+" not permitted","error"),alert("This file type is not permitted"),p.domInput.value="",p.clearInput())}},p.uploaded=[],p.uri="/"+u.replace(/^\//,"").replace(/\/$/,"");for(var i in a)p.settings[i]=a[i];if(p.multiple&&(p.settings.clearoncomplete=!0),p.domPseudo.value&&""!==p.domPseudo.value&&(p.uploaded=p.domPseudo.value.split(",")||[]),t=p.settings.debug===!0,p.domCountWrapper&&!p.settings.counter&&(p.domCountWrapper.style.display="none"),p.domCancelUpload&&!p.settings.abortable&&(p.domCancelUpload.style.display="none"),p.domCancelUpload.style.display="none",p.domClearUpload.style.display="none",!p.domInput)throw'No element exists with the id="'+e+'"';p.domInput.addEventListener("change",this.upload),p.hideProgress();var c=p.domInput.getAttribute("accept");return c&&(p.accept=c.replace("/","\\/").replace("*",".*").split(",")),p.domPseudo.name=p.domInput.name,p.domInput.removeAttribute("name"),p}catch(m){n(m,"error")}};e.twistUploader=function(e,o,t){return new a(e,o,t)}}(window,document);