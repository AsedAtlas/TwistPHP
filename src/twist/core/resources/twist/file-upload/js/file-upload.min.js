/**
 * This file is part of TwistPHP.
 *
 * TwistPHP is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * TwistPHP is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with TwistPHP.  If not, see <http://www.gnu.org/licenses/>.
 *
 * @author     Shadow Technologies Ltd. <contact@shadow-technologies.co.uk>
 * @license    https://www.gnu.org/licenses/gpl.html LGPL License
 * @link       https://twistphp.com
 *
 */

!function(e,t){var o=!1,n=function(t,n){o&&e.console&&(e.console[n]?e.console[n](t):e.console.log&&console.log(t))},u=function(e){for(var t=["B","kB","MB","GB","TB","PB","EB","ZB","YB"],o=0;t[o]&&e>Math.pow(1024,o+1);)o++;return r(e/Math.pow(1024,o),o>1?2:0)+t[o]},r=function(e,t){return t="number"!=typeof t?0:t,0===t?parseInt(Math.round(e*Math.pow(10,t))/Math.pow(10,t)):parseFloat(Math.round(e*Math.pow(10,t))/Math.pow(10,t))},s=function(e,r,s){try{var a=this;a.created=(new Date).getTime(),a.cancelUpload=function(e){e.preventDefault(),a.request.abort()},a.domCancelUpload=t.getElementById(e+"-cancel"),a.domCount=t.getElementById(e+"-count"),a.domCountWrapper=t.getElementById(e+"-count-wrapper"),a.domCountWrapperDisplay=a.domCountWrapper?a.domCountWrapper.style.display:"inline-block",a.domCountTotal=t.getElementById(e+"-total"),a.domInput=t.getElementById(e),a.domInputDisplay=a.domInput?a.domInput.style.display:"inline-block",a.domProgress=t.getElementById(e+"-progress"),a.domProgressWrapper=t.getElementById(e+"-progress-wrapper"),a.hideProgress=function(){a.domInput.style.display=this.domInputDisplay,a.domProgressWrapper&&(a.domProgressWrapper.style.display="none"),a.domCancelUpload&&a.domCancelUpload.removeEventListener("click",a.cancelUpload)},a.queue=[],a.queueCount=0,a.queueSize=0,a.queueUploadedCount=0,a.queueUploadedSize=0,a.request=new XMLHttpRequest,a.settings={abortable:!0,clearoncomplete:!0,counter:!0,debug:!1,onabort:function(){},oncompletefile:function(){},oncompletequeue:function(){},onerror:function(){},onprogress:function(){},verbose:!1},a.showProgress=function(){a.domInput.style.display="none",a.domProgressWrapper&&(a.domProgressWrapper.style.display=this.domInputDisplay),a.domCancelUpload&&a.domCancelUpload.addEventListener("click",a.cancelUpload)},a.uid=e,a.upload=function(e){if(e){var t=e.target||e.srcElement,o=t.files;a.queue.push.apply(a.queue,o),a.queueCount+=o.length;for(var r=0,s=o.length;s>r;r++)a.queueSize+=parseInt(o[r].size);a.domCountTotal&&(a.domCountTotal.innerText=a.queueCount),n("Added "+o.length+" files to the queue","info")}if(a.queue.length){var d=a.queue[0],l=d.name,p=parseInt(d.size),i=new FileReader({blob:!0});a.showProgress(),a.domCount&&(a.domCount.innerText=a.queueUploadedCount+1),1===a.queueCount?(a.domProgress&&a.domProgress.removeAttribute("value"),a.domCountWrapper&&(a.domCountWrapper.style.display="none")):a.domCountWrapper&&(a.domCountWrapper.style.display=a.domCountWrapperDisplay),i.addEventListener("load",function(){a.request.onreadystatechange=function(){switch(a.request.status){case 200:4==a.request.readyState&&(n("Uploaded "+l+" ("+u(p)+")"),a.queue.shift(),a.queueUploadedCount++,a.queueUploadedSize+=p,a.queue.length?(a.settings.oncompletefile(d,JSON.parse(a.request.responseText)),a.upload()):(a.hideProgress(),a.settings.clearoncomplete&&(a.domInput.value="",a.domInput.value&&(a.domInput.type="text",a.domInput.type="file")),n("Finsihed uploading "+a.queueUploadedCount+" files ("+u(a.queueUploadedSize)+")","info"),a.queueCount=0,a.queueSize=0,a.queueUploadedCount=0,a.queueUploadedSize=0,a.settings.oncompletefile(d,JSON.parse(a.request.responseText)),a.settings.oncompletequeue()));break;case 403:n("Permission denied","error"),a.queue.shift(),a.queueCount--,a.queueSize--,a.settings.onerror(d),a.queue.length?a.upload():a.hideProgress();break;case 404:n("Invalid function call","error"),a.queue.shift(),a.queueCount--,a.queueSize--,a.settings.onerror(d),a.queue.length?a.upload():a.hideProgress()}},a.request.onprogress=function(e){if(e.lengthComputable){if(a.domProgress){var t=Math.round(e.loaded/e.total*100);a.domProgress.value=t,a.settings.verbose&&n(u(e.loaded)+"/"+u(e.total)+" ("+t+"%)")}a.settings.onprogress(d,e.loaded,e.total)}},a.request.upload.onprogress=a.request.onprogress,a.request.addEventListener("load",function(){},!1),a.request.addEventListener("error",function(){a.queue.length&&(a.hideProgress(),a.queue=[],a.queueCount=0,a.queueSize=0,a.queueUploadedCount=0,a.queueUploadedSize=0,a.settings.onerror(d),n("An error occurred","error"))},!1),a.request.addEventListener("abort",function(){a.queue.length&&(a.hideProgress(),a.queue=[],a.queueCount=0,a.queueSize=0,a.queueUploadedCount=0,a.queueUploadedSize=0,a.settings.onabort(d),n("Upload aborted","warning"))},!1),a.request.open("PUT",a.uri,!0),a.request.setRequestHeader("Accept",'"text/plain; charset=iso-8859-1", "Content-Type": "text/plain; charset=iso-8859-1"'),a.request.setRequestHeader("Twist-File",l),a.request.setRequestHeader("Twist-Length",p),a.request.setRequestHeader("Twist-UID",a.uid),a.request.send(i.result)},!1),i.readAsArrayBuffer(d)}},a.uri="/"+r.replace(/^\//,"").replace(/\/$/,"");for(var d in s)a.settings[d]=s[d];if(o=1==a.settings.debug,a.domCountWrapper&&!a.settings.counter&&(a.domCountWrapper.style.display="none"),a.domCancelUpload&&!a.settings.abortable&&(a.domCancelUpload.style.display="none"),!a.domInput)throw'No element exists with the id="'+e+'"';return a.domInput.addEventListener("change",this.upload),a.hideProgress(),a}catch(l){n(l,"error")}};e.twistUploader=function(e,t,o){return new s(e,t,o)}}(window,document);