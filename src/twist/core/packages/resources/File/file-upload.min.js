/**
 * This file is part of TwistPHP.
 *
 * TwistPHP is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * TwistPHP is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with TwistPHP.  If not, see <http://www.gnu.org/licenses/>.
 *
 * @author     Shadow Technologies Ltd. <contact@shadow-technologies.co.uk>
 * @license    https://www.gnu.org/licenses/gpl.html LGPL License
 * @link       http://twistphp.com
 *
 */
(function(e,t){var n=function(t,n){if(e.console){if(e.console[n]){e.console[n](t)}else if(e.console.log){console.log(t)}}},r=function(e){var t=["B","kB","MB","GB","TB","PB","EB","ZB","YB"],n=0;while(t[n]&&e>Math.pow(1024,n+1)){n++}return i(e/Math.pow(1024,n),n>1?2:0)+t[n]},i=function(e,t){t=typeof t!=="number"?0:t;return t===0?parseInt(Math.round(e*Math.pow(10,t))/Math.pow(10,t)):parseFloat(Math.round(e*Math.pow(10,t))/Math.pow(10,t))},s=function(e,i,s){try{var o=this;o.created=(new Date).getTime(),o.cancelUpload=function(e){e.preventDefault();o.request.abort()},o.domCancelUpload=t.getElementById(e+"-cancel"),o.domCount=t.getElementById(e+"-count"),o.domCountWrapper=t.getElementById(e+"-count-wrapper"),o.domCountWrapperDisplay=o.domCountWrapper?o.domCountWrapper.style.display:"inline-block",o.domCountTotal=t.getElementById(e+"-total"),o.domInput=t.getElementById(e),o.domInputDisplay=o.domInput?o.domInput.style.display:"inline-block",o.domProgress=t.getElementById(e+"-progress"),o.domProgressWrapper=t.getElementById(e+"-progress-wrapper"),o.hideProgress=function(){o.domInput.style.display=this.domInputDisplay;if(o.domProgressWrapper){o.domProgressWrapper.style.display="none"}if(o.domCancelUpload){o.domCancelUpload.removeEventListener("click",o.cancelUpload)}},o.process=i,o.queue=[],o.queueCount=0,o.queueSize=0,o.queueUploadedCount=0,o.queueUploadedSize=0,o.request=new XMLHttpRequest,o.settings={abortable:true,clearoncomplete:true,counter:true,onabort:function(){},oncompletefile:function(){},oncompletequeue:function(){},onerror:function(){},onprogress:function(){}},o.showProgress=function(){o.domInput.style.display="none";if(o.domProgressWrapper){o.domProgressWrapper.style.display=this.domInputDisplay}if(o.domCancelUpload){o.domCancelUpload.addEventListener("click",o.cancelUpload)}},o.uid=e,o.upload=function(e){if(e){var t=e.target||e.srcElement,i=t.files;o.queue.push.apply(o.queue,i);o.queueCount+=i.length;for(var s=0,u=i.length;s<u;s++){o.queueSize+=parseInt(i[s].size)}if(o.domCountTotal){o.domCountTotal.innerText=o.queueCount}n("Added "+i.length+" files to the queue","info")}if(o.queue.length){var a=o.queue[0],f=a.name,l=parseInt(a.size),c=new FileReader({blob:true});o.showProgress();if(o.domCount){o.domCount.innerText=o.queueUploadedCount+1}if(o.queueCount===1){if(o.domProgress){o.domProgress.removeAttribute("value")}if(o.domCountWrapper){o.domCountWrapper.style.display="none"}}else if(o.domCountWrapper){o.domCountWrapper.style.display=o.domCountWrapperDisplay}c.addEventListener("load",function(e){o.request.onreadystatechange=function(){switch(o.request.status){case 200:if(o.request.readyState==4){n("Uploaded "+f+" ("+r(l)+")");o.queue.shift();o.queueUploadedCount++;o.queueUploadedSize+=l;if(o.queue.length){o.settings.oncompletefile(a,JSON.parse(o.request.responseText));o.upload()}else{o.hideProgress();if(o.settings.clearoncomplete){o.domInput.value="";if(o.domInput.value){o.domInput.type="text";o.domInput.type="file"}}n("Uploaded "+o.queueUploadedCount+" files ("+r(o.queueUploadedSize)+")","info");o.queueCount=0;o.queueSize=0;o.queueUploadedCount=0;o.queueUploadedSize=0;o.settings.oncompletefile(a,JSON.parse(o.request.responseText));o.settings.oncompletequeue()}}break;case 403:n("Permission denied","error");o.queue.shift();o.queueCount--;o.queueSize--;o.settings.onerror(a);if(o.queue.length){o.upload()}else{o.hideProgress()}break;case 404:n("Invalid function call","error");o.queue.shift();o.queueCount--;o.queueSize--;o.settings.onerror(a);if(o.queue.length){o.upload()}else{o.hideProgress()}break}},o.request.onprogress=function(e){if(e.lengthComputable){if(o.domProgress){o.domProgress.value=Math.round(e.loaded/e.total*100)}o.settings.onprogress(a,e.loaded,e.total)}},o.request.upload.onprogress=o.request.onprogress,o.request.addEventListener("load",function(){},false),o.request.addEventListener("error",function(){if(o.queue.length){o.hideProgress();o.queue=[];o.queueCount=0;o.queueSize=0;o.queueUploadedCount=0;o.queueUploadedSize=0;o.settings.onerror(a);n("An error occurred","error")}},false),o.request.addEventListener("abort",function(){if(o.queue.length){o.hideProgress();o.queue=[];o.queueCount=0;o.queueSize=0;o.queueUploadedCount=0;o.queueUploadedSize=0;o.settings.onabort(a);n("Upload aborted","warning")}},false),o.request.open("PUT","/twist/core/scripts/upload.php",true),o.request.setRequestHeader("Accept",'"text/plain; charset=iso-8859-1", "Content-Type": "text/plain; charset=iso-8859-1"'),o.request.setRequestHeader("Twist-File",f),o.request.setRequestHeader("Twist-Length",l),o.request.setRequestHeader("Twist-UID",o.uid),o.request.setRequestHeader("Twist-Process",o.process),o.request.send(c.result)},false);c.readAsArrayBuffer(a)}};for(var u in s){o.settings[u]=s[u]}if(o.domCountWrapper&&!o.settings.counter){o.domCountWrapper.style.display="none"}if(o.domCancelUpload&&!o.settings.abortable){o.domCancelUpload.style.display="none"}if(o.domInput){o.domInput.addEventListener("change",this.upload);o.hideProgress()}else{throw'No element exists with the id="'+e+'"'}return o}catch(a){n(a,"error")}};e.twistUploader=function(e,t,n){return new s(e,t,n)}})(window,document)