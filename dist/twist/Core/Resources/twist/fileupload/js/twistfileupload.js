!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.twistfileupload=t()}(this,function(){"use strict";function e(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var t=function(){function e(e,t){for(var s=0;s<t.length;s++){var n=t[s];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,s,n){return s&&e(t.prototype,s),n&&e(t,n),t}}(),s=function(e,t){return-1!==e.className.indexOf(t)},n=function(e,t){s(e,t)||(e.className+=" "+t)},i=function(e,t){s(e,t)&&(e.className=e.className.replace(new RegExp("^"+t+"$","g"),"").replace(new RegExp("^"+t+" ","g"),"").replace(new RegExp(" "+t+"$","g"),"").replace(new RegExp(" "+t+" ","g")," "))},o=function(e){for(var t=["B","kB","MB","GB","TB","PB","EB","ZB","YB"],s=0;t[s]&&e>Math.pow(1024,s+1);)s++;return l(e/Math.pow(1024,s),s>1?2:0)+t[s]},l=function(e,t){return t="number"!=typeof t?0:t,0===t?parseInt(Math.round(e*Math.pow(10,t))/Math.pow(10,t)):parseFloat(Math.round(e*Math.pow(10,t))/Math.pow(10,t))},u="string"==typeof(new XMLHttpRequest).responseType&&"withCredentials"in new XMLHttpRequest;return function(){function s(t,o,l){var r=this;if(e(this,s),u){var a=new XMLHttpRequest;a.open("GET","/");try{a.responseType="arraybuffer"}catch(e){u=!1}}if(this.id=t,this.created=(new Date).getTime(),this.debug=!1,this.elements={CancelUpload:document.getElementById(this.id+"-cancel"),Count:document.getElementById(this.id+"-count"),CountWrapper:document.getElementById(this.id+"-count-wrapper"),CountTotal:document.getElementById(this.id+"-total"),Input:document.getElementById(this.id),List:document.getElementById(this.id+"-list"),Progress:document.getElementById(this.id+"-progress"),ProgressWrapper:document.getElementById(this.id+"-progress-wrapper"),Pseudo:document.getElementById(this.id+"-pseudo")},this.acceptExtentions=[],this.acceptRaw=[],this.acceptTypes=[],this.domCountWrapperDisplay=null,this.domInputDisplay=null,this.domCancelUploadDisplay=null,this.multiple=this.element("Input")&&this.element("Input").hasAttribute("multiple")||!1,this.queue=[],this.queueCount=0,this.queueSize=0,this.queueUploadedCount=0,this.queueUploadedSize=0,this.request=new XMLHttpRequest,this.supported=!1,this.uploaded=[],this.uri="/"+o.replace(/^\//,"").replace(/\/$/,""),this.settings={abortable:!0,counter:!0,debug:!1,dragdrop:null,dropableclass:"twistupload-dropable",hoverclass:"twistupload-hover",invalidtypemessage:"This file type is not permitted",onabort:function(){},onclear:function(){},oncompletefile:function(){},oncompletequeue:function(){},onerror:function(){},oninvalidtype:function(){},onprogress:function(){},onstart:function(){},previewsize:128,previewsquare:!0},this.boundCancelUpload=function(e){r.cancelUpload()},this.element("Pseudo")&&this.element("Pseudo").value&&""!==this.element("Pseudo").value&&(this.uploaded=this.element("Pseudo").value.split(",")||[]),this.element("CountWrapper")&&!this.settings.counter&&(this.element("CountWrapper").style.display="none"),this.element("CancelUpload")&&!this.settings.abortable&&(this.element("CancelUpload").style.display="none"),this.hideProgress(),null!==this.settings.dragdrop){var p=document.getElementById(this.settings.dragdrop);p&&(p.ondrop=function(e){e.preventDefault(),r.upload(e,e.target.files||e.dataTransfer.files),i(p,r.settings.hoverclass),i(p,r.settings.dropableclass)},p.ondragstart=function(){return n(p,r.settings.dropableclass),!1},p.ondragover=function(){return n(p,r.settings.hoverclass),!1},p.ondragleave=function(){return i(p,r.settings.hoverclass),!1},p.ondragend=function(){return i(p,r.settings.hoverclass),i(p,r.settings.dropableclass),!1})}var d=this.element("Input")?this.element("Input").getAttribute("accept"):"";if(d){var h=d.replace(/ /g,"").split(",");if(h.length)for(var c in h)"."===h[c].substr(0,1)?this.acceptExtentions.push(h[c].substr(1).toLowerCase()):this.acceptTypes.push(h[c].replace(/\//g,"\\/").replace(/\*/g,".*")),this.acceptRaw.push(h[c])}if(u){if(!this.element("Input"))throw'No element exists with id="'+this.id+'"';this.element("Pseudo")&&(this.element("Pseudo").name=this.element("Input").name.replace("[]",""),this.element("Input").removeAttribute("name")),this.element("Input").addEventListener("change",function(e,t){r.upload(e,t)})}else this.hideProgress(),console.warn("Your browser does not support AJAX uploading","warn",!0)}return t(s,[{key:"element",value:function(e){return this.elements[e]||null}},{key:"upload",value:function(e,t){var s=this;try{if(e){var n=t||(e.target||e.srcElement).files;this.queue.push.apply(this.queue,n),this.queueCount+=n.length;for(var i=0,l=n.length;i<l;i++)this.queueSize+=parseInt(n[i].size);this.element("CountTotal")&&(this.element("CountTotal").innerText=this.queueCount),console.log("Added "+n.length+" files to the queue","info")}if(null===this.domCancelUploadDisplay&&(this.domCancelUploadDisplay=this.element("CancelUpload").style.display||"inline-block"),null===this.domCountWrapperDisplay&&(this.domCountWrapperDisplay=this.element("CountWrapper").style.display||"inline-block"),null===this.domInputDisplay&&(this.domInputDisplay=this.element("Input").style.display||"inline-block"),this.queue.length){var u=this.queue[0],r=u.name,a=u.type,p=r.substr(r.lastIndexOf(".")+1).toLowerCase(),d=parseInt(u.size),h=new FileReader({blob:!0}),c=!this.acceptTypes.length&&!this.acceptExtentions.length;if(!c)for(var m in this.acceptTypes)if(new RegExp("^"+this.acceptTypes[m]+"$","gi").test(a)){c=!0;break}if(!c)for(var f in this.acceptExtentions)if(p===this.acceptExtentions[f]){c=!0;break}if(c)this.settings.onstart(u),this.showProgress(),this.element("Count")&&(this.element("Count").innerText=this.queueUploadedCount+1),1===this.queueCount?(this.element("Progress")&&this.element("Progress").removeAttribute("value"),this.element("CountWrapper")&&(this.element("CountWrapper").style.display="none")):this.element("CountWrapper")&&(this.element("CountWrapper").style.display=this.element("CountWrapperDisplay")),h.addEventListener("load",function(e){s.request.onreadystatechange=function(){switch(s.request.status){case 200:if(4===s.request.readyState){console.info("Uploaded "+r+" ("+o(d)+")"),s.queue.shift(),s.queueUploadedCount++,s.queueUploadedSize+=d;var e=JSON.parse(s.request.responseText);s.queue.length?(s.multiple?s.uploaded.push(e):s.uploaded=[e.form_value],s.updateUploadedList(),window.twist.debug&&window.twist.debug.logFileUpload(u,e),s.settings.oncompletefile(e,u),s.upload()):(s.hideProgress(),console.info("Finished uploading "+s.queueUploadedCount+" files ("+o(s.queueUploadedSize)+")","info"),s.queueCount=0,s.queueSize=0,s.queueUploadedCount=0,s.queueUploadedSize=0,s.clearInput(),s.multiple?s.uploaded.push(e):s.uploaded=[e],s.updateUploadedList(),window.twist.debug&&window.twist.debug.logFileUpload(u,e),s.settings.oncompletefile(e,u),s.settings.oncompletequeue())}break;case 403:console.error("Permission denied","error"),s.queue.shift(),s.queueCount--,s.queueSize--,s.settings.onerror(u),s.queue.length?s.upload():s.hideProgress();break;case 404:console.error("Invalid function call","error"),s.queue.shift(),s.queueCount--,s.queueSize--,s.settings.onerror(u),s.queue.length?s.upload():s.hideProgress()}},s.request.onprogress=function(e){if(e.lengthComputable){if(s.element("Progress")){var t=Math.round(e.loaded/e.total*100);s.element("Progress").value=t,console.log(o(e.loaded)+"/"+o(e.total)+" ("+t+"%)")}s.settings.onprogress(u,e.loaded,e.total)}},s.request.upload.onprogress=s.request.onprogress,s.request.addEventListener("load",function(){},!1),s.request.addEventListener("error",function(){s.queue.length&&(s.hideProgress(),s.queue=[],s.queueCount=0,s.queueSize=0,s.queueUploadedCount=0,s.queueUploadedSize=0,s.settings.onerror(u),console.error("An error occurred","error"))},!1),s.request.addEventListener("abort",function(){s.queue.length&&(s.hideProgress(),s.queue=[],s.queueCount=0,s.queueSize=0,s.queueUploadedCount=0,s.queueUploadedSize=0,s.settings.onabort(u),console.error("Upload aborted","warning"))},!1),s.request.open("PUT",s.uri,!0),s.request.setRequestHeader("Accept",'"text/plain; charset=iso-8859-1", "Content-Type": "text/plain; charset=iso-8859-1"'),s.request.setRequestHeader("Twist-File",r),s.request.setRequestHeader("Twist-Length",d),s.request.setRequestHeader("Twist-UID",s.id),s.request.send(h.result)}),h.readAsArrayBuffer(u);else{var g=this.queue.shift();this.element("Input").value="",this.settings.oninvalidtype(g,this.acceptTypes,this.acceptExtentions),console.error(r+" ("+a+") is not in the list of allowed types","warn"),this.acceptTypes.length&&console.info("Allowed MIME types: "+this.acceptTypes.join(", ")),this.acceptExtentions.length&&console.info("Allowed file extensions: "+this.acceptExtentions.join(", ")),this.clearInput()}}}catch(e){console.log(this),this.hideProgress(),this.settings.onerror(this.queue[0]),this.settings.onabort(this.queue[0]),this.queue=[],this.queueCount=0,this.queueSize=0,this.queueUploadedCount=0,this.queueUploadedSize=0,console.error(e,"error")}}},{key:"addRemoveFileListener",value:function(){var e=this,t=function(t){return function(){console.log("Remove"),e.removeFileFromListFunction(t)}};for(var s in this.uploaded){var n=document.getElementById(this.id+"-remove-"+s);n.removeEventListener("click",t(s)),n.addEventListener("click",t(s))}}},{key:"hideProgress",value:function(){this.element("Input")&&(this.element("Input").style.display=this.element("InputDisplay")),this.element("ProgressWrapper")&&(this.element("ProgressWrapper").style.display="none"),this.element("CancelUpload")&&this.element("CancelUpload").removeEventListener("click",this.boundCancelUpload)}},{key:"cancelUpload",value:function(){this.request.abort()}},{key:"clearInput",value:function(){this.element("Input").value="",this.element("Input").value&&(this.element("Input").type="text",this.element("Input").type="file"),this.element("Pseudo").value="",this.settings.onclear()}},{key:"removeFileFromListFunction",value:function(e){this.uploaded.splice(e,1),this.updateUploadedList()}},{key:"showProgress",value:function(){this.element("Input").style.display="none",this.element("ProgressWrapper")&&(this.element("ProgressWrapper").style.display=this.element("InputDisplay")),this.element("CancelUpload")&&this.element("CancelUpload").addEventListener("click",this.boundCancelUpload)}},{key:"updateUploadedList",value:function(){var e="",t=[];for(var s in this.uploaded){var n=this.uploaded[s],i=n.uri_preview,o="",l=["file/name","file/size","file_type"];t.push(n.form_value);var u="thumb-"+this.settings.previewsize;this.settings.previewsquare&&(u="square-"+u),n.support&&n.support[u]&&(i=n.support[u]);for(var r in l){var a=l[r],p=void 0;if(-1!==a.indexOf("/")){var d=a.split("/"),h=n[d[0]]||null;if(d.shift(),h){for(var c in d)h=h[d[c]]||null;p=h||null}}else p=n[a]||null;o+='<li data-key="'+a+'"><span>'+a.replace(/[\/_]/g," ")+" :</span>"+p+"</li>"}e+='<li class="twistupload-file-list-item"><img src="'+i+'"><ul class="twistupload-file-info">'+o+'</ul><button id="'+this.id+"-remove-"+s+'" data-file="'+s+'">Remove</button></li>'}this.element("Pseudo").value=t.join(","),this.element("List").innerHTML=e,this.addRemoveFileListener()}}]),s}()});
//# sourceMappingURL=twistfileupload.js.map
