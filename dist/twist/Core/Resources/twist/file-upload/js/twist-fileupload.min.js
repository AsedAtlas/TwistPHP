!function(e,t){"function"==typeof define&&define.amd?define("twistfileupload",["postal"],function(o){return e.twistfileupload=t(o)}):"object"==typeof module&&module.exports?module.exports=e.twistfileupload=t(require("postal")):e.twistfileupload=t(e.postal)}(this,function(e){var t=function(e,t,o){var n=!0,r=function(e,t,o){(n||o===!0)&&window.console&&(window.console[t]?window.console[t](e):window.console.log&&console.log(e))},u=function(e,t){return-1!==e.className.indexOf(t)},a=function(e,t){u(e,t)||(e.className+=" "+t)},d=function(e,t){u(e,t)&&(e.className=e.className.replace(new RegExp("^"+t+"$","g"),"").replace(new RegExp("^"+t+" ","g"),"").replace(new RegExp(" "+t+"$","g"),"").replace(new RegExp(" "+t+" ","g")," "))},l=function(e){for(var t=["B","kB","MB","GB","TB","PB","EB","ZB","YB"],o=0;t[o]&&e>Math.pow(1024,o+1);)o++;return s(e/Math.pow(1024,o),o>1?2:0)+t[o]},s=function(e,t){return t="number"!=typeof t?0:t,0===t?parseInt(Math.round(e*Math.pow(10,t))/Math.pow(10,t)):parseFloat(Math.round(e*Math.pow(10,t))/Math.pow(10,t))},p="string"==typeof(new XMLHttpRequest).responseType&&"withCredentials"in new XMLHttpRequest;if(p){var i=new XMLHttpRequest;i.open("GET","/");try{i.responseType="arraybuffer"}catch(c){p=!1}}var m=this;m.acceptExtentions=[],m.acceptRaw=[],m.acceptTypes=[],m.addRemoveFileListener=function(){console.info("addRemoveFileListener");for(var t in m.uploaded){var o=document.getElementById(e+"-remove-"+t),n=function(e){return function(){m.removeFileFromListFunction(e)}}(t);o.removeEventListener("click",n),o.addEventListener("click",n)}},m.created=(new Date).getTime(),m.cancelUpload=function(){m.request.abort()},m.clearInput=function(){m.domInput.value="",m.domInput.value&&(m.domInput.type="text",m.domInput.type="file"),m.hideClear(),m.domPseudo.value="",m.settings.onclear()},m.domCancelUpload=document.getElementById(e+"-cancel"),m.domCancelUploadDisplay=null,m.domClearUpload=document.getElementById(e+"-clear"),m.domCount=document.getElementById(e+"-count"),m.domCountWrapper=document.getElementById(e+"-count-wrapper"),m.domCountWrapperDisplay=null,m.domCountTotal=document.getElementById(e+"-total"),m.domInput=document.getElementById(e),m.domInputDisplay=null,m.domList=document.getElementById(e+"-list"),m.domProgress=document.getElementById(e+"-progress"),m.domProgressWrapper=document.getElementById(e+"-progress-wrapper"),m.domPseudo=document.getElementById(e+"-pseudo"),m.hideClear=function(){m.domClearUpload&&(m.domClearUpload.style.display="none",m.domClearUpload.removeEventListener("click",m.clearInput))},m.hideProgress=function(){m.domInput&&(m.domInput.style.display=m.domInputDisplay),m.domProgressWrapper&&(m.domProgressWrapper.style.display="none"),m.domCancelUpload&&m.domCancelUpload.removeEventListener("click",m.cancelUpload)},m.multiple=m.domInput&&m.domInput.hasAttribute("multiple"),m.queue=[],m.queueCount=0,m.queueSize=0,m.queueUploadedCount=0,m.queueUploadedSize=0,m.removeFileFromListFunction=function(e){console.info("Removed file #"+e),m.uploaded.splice(e,1),m.updateUploadedList()},m.request=new XMLHttpRequest,m.settings={abortable:!0,clearoncomplete:!0,counter:!0,debug:!1,dragdrop:null,onabort:function(){},onclear:function(){},oncompletefile:function(){},oncompletequeue:function(){},onerror:function(){},onprogress:function(){},onstart:function(){}},m.showClear=function(){m.domClearUpload&&(m.domClearUpload.style.display=this.domInputDisplay,m.domClearUpload.addEventListener("click",m.clearInput))},m.showProgress=function(){m.domInput.style.display="none",m.domProgressWrapper&&(m.domProgressWrapper.style.display=m.domInputDisplay),m.domCancelUpload&&m.domCancelUpload.addEventListener("click",m.cancelUpload)},m.supported=!1,m.uid=e,m.updateUploadedList=function(){console.info("updateUploadedList");var t="",o=[];for(var n in m.uploaded){var u=m.uploaded[n],a=u.uri_preview,d="",l=["file/name","file/size","file_type"];r(u),o.push(u.form_value),u.support&&u.support["square-thumb-128"]&&(a=u.support["square-thumb-128"]);for(var s in l){var p=l[s],i=u[p];if(-1!==p.indexOf("/")){var c=p.split("/"),f=u[c[0]];c.shift();for(var g in c)f=f[c[g]];i=f}d+='<li data-key="'+p+'"><span>'+p.replace(/[\/_]/g," ")+" :</span>"+i+"</li>"}t+='<li><img src="'+a+'"><ul>'+d+'</ul><button id="'+e+"-remove-"+n+'" data-file="'+n+'">Remove</button></li>'}m.domPseudo.value=o.join(","),m.domList.innerHTML=t,m.addRemoveFileListener()},m.upload=function(e,t){try{if(e){var o=t?t:(e.target||e.srcElement).files;m.queue.push.apply(m.queue,o),m.queueCount+=o.length;for(var n=0,u=o.length;u>n;n++)m.queueSize+=parseInt(o[n].size);m.domCountTotal&&(m.domCountTotal.innerText=m.queueCount),r("Added "+o.length+" files to the queue","info")}if(null===m.domCancelUploadDisplay&&(m.domCancelUploadDisplay=m.domCancelUpload.style.display||"inline-block"),null===m.domCountWrapperDisplay&&(m.domCountWrapperDisplay=m.domCountWrapper.style.display||"inline-block"),null===m.domInputDisplay&&(m.domInputDisplay=m.domInput.style.display||"inline-block"),m.queue.length){var a=m.queue[0],d=a.name,s=a.type,p=d.substr(d.lastIndexOf(".")+1).toLowerCase(),i=parseInt(a.size),c=new FileReader({blob:!0}),f=!m.acceptTypes.length&&!m.acceptExtentions.length;if(!f)for(var g in m.acceptTypes)if(new RegExp("^"+m.acceptTypes[g]+"$","gi").test(s)){f=!0;break}if(!f)for(var q in m.acceptExtentions)if(p===m.acceptExtentions[q]){f=!0;break}f?(m.settings.onstart(a),m.showProgress(),m.domCount&&(m.domCount.innerText=m.queueUploadedCount+1),1===m.queueCount?(m.domProgress&&m.domProgress.removeAttribute("value"),m.domCountWrapper&&(m.domCountWrapper.style.display="none")):m.domCountWrapper&&(m.domCountWrapper.style.display=m.domCountWrapperDisplay),c.addEventListener("load",function(e){m.request.onreadystatechange=function(){switch(m.request.status){case 200:if(4==m.request.readyState){r("Uploaded "+d+" ("+l(i)+")"),m.queue.shift(),m.queueUploadedCount++,m.queueUploadedSize+=i;var e=JSON.parse(m.request.responseText);m.queue.length?(m.multiple?m.uploaded.push(e):m.uploaded=[e.form_value],m.updateUploadedList(),m.settings.oncompletefile(e,a),m.upload()):(m.hideProgress(),r("Finsihed uploading "+m.queueUploadedCount+" files ("+l(m.queueUploadedSize)+")","info"),m.queueCount=0,m.queueSize=0,m.queueUploadedCount=0,m.queueUploadedSize=0,m.settings.clearoncomplete?(m.clearInput(),m.hideClear()):m.showClear(),m.multiple?m.uploaded.push(e):m.uploaded=[e],m.updateUploadedList(),m.settings.oncompletefile(e,a),m.settings.oncompletequeue())}break;case 403:r("Permission denied","error"),m.queue.shift(),m.queueCount--,m.queueSize--,m.settings.onerror(a),m.queue.length?m.upload():m.hideProgress();break;case 404:r("Invalid function call","error"),m.queue.shift(),m.queueCount--,m.queueSize--,m.settings.onerror(a),m.queue.length?m.upload():m.hideProgress()}},m.request.onprogress=function(e){if(e.lengthComputable){if(m.domProgress){var t=Math.round(e.loaded/e.total*100);m.domProgress.value=t,r(l(e.loaded)+"/"+l(e.total)+" ("+t+"%)")}m.settings.onprogress(a,e.loaded,e.total)}},m.request.upload.onprogress=m.request.onprogress,m.request.addEventListener("load",function(){},!1),m.request.addEventListener("error",function(){m.queue.length&&(m.hideProgress(),m.queue=[],m.queueCount=0,m.queueSize=0,m.queueUploadedCount=0,m.queueUploadedSize=0,m.settings.onerror(a),r("An error occurred","error"))},!1),m.request.addEventListener("abort",function(){m.queue.length&&(m.hideProgress(),m.queue=[],m.queueCount=0,m.queueSize=0,m.queueUploadedCount=0,m.queueUploadedSize=0,m.settings.onabort(a),r("Upload aborted","warning"))},!1),m.request.open("PUT",m.uri,!0),m.request.setRequestHeader("Accept",'"text/plain; charset=iso-8859-1", "Content-Type": "text/plain; charset=iso-8859-1"'),m.request.setRequestHeader("Twist-File",d),m.request.setRequestHeader("Twist-Length",i),m.request.setRequestHeader("Twist-UID",m.uid),m.request.send(c.result)}),c.readAsArrayBuffer(a)):(m.queue.shift(),m.domInput.value="",r(d+" ("+s+") is not in the list of allowed types","warn"),m.acceptTypes.length&&r("Allowed MIME types: "+m.acceptTypes.join(", ")),m.acceptExtentions.length&&r("Allowed file extenstions: "+m.acceptExtentions.join(", ")),alert("This file type is not permitted"),m.clearInput())}}catch(y){m.hideProgress(),m.settings.onerror(m.queue[0]),m.settings.onabort(m.queue[0]),m.queue=[],m.queueCount=0,m.queueSize=0,m.queueUploadedCount=0,m.queueUploadedSize=0,r(y,"error")}},m.uploaded=[],m.uri="/"+t.replace(/^\//,"").replace(/\/$/,"");for(var f in o)m.settings[f]=o[f];if(m.multiple&&(m.settings.clearoncomplete=!0),m.domPseudo&&m.domPseudo.value&&""!==m.domPseudo.value&&(m.uploaded=m.domPseudo.value.split(",")||[]),n=m.settings.debug===!0,m.domCountWrapper&&!m.settings.counter&&(m.domCountWrapper.style.display="none"),m.domCancelUpload&&!m.settings.abortable&&(m.domCancelUpload.style.display="none"),m.domClearUpload&&(m.domClearUpload.style.display="none"),m.hideProgress(),null!==m.settings.dragdrop){var g=document.getElementById(m.settings.dragdrop);g&&(g.ondrop=function(e){e.preventDefault(),m.upload(e,e.target.files||e.dataTransfer.files),d(g,"hover"),d(g,"droppable")},g.ondragstart=function(){return a(g,"droppable"),!1},g.ondragover=function(){return a(g,"hover"),!1},g.ondragleave=function(){return d(g,"hover"),!1},g.ondragend=function(){return d(g,"hover"),d(g,"droppable"),!1})}var q=m.domInput?m.domInput.getAttribute("accept"):"";if(q){var y=q.replace(/ /g,"").split(",");if(y.length)for(var h in y)"."===y[h].substr(0,1)?m.acceptExtentions.push(y[h].substr(1).toLowerCase()):m.acceptTypes.push(y[h].replace(/\//g,"\\/").replace(/\*/g,".*")),m.acceptRaw.push(y[h])}if(m.domPseudo&&m.domInput&&(m.domPseudo.name=m.domInput.name.replace("[]",""),m.domInput.removeAttribute("name")),!p)return m.hideClear(),m.hideProgress(),r("Your browser does not support AJAX uploading","warn",!0),null;try{return m.domInput&&m.domInput.addEventListener("change",m.upload),m}catch(v){r(v,"error")}};return function(e,o,n){return new t(e,o,n)}});