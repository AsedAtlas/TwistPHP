!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.twistfileupload=t()}(this,function(){"use strict";var e=function(){function e(e,t){for(var s=0;s<t.length;s++){var n=t[s];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,s,n){return s&&e(t.prototype,s),n&&e(t,n),t}}();function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var s=function(){function s(e){return t(this,s),this.el=e,this}return e(s,[{key:"show",value:function(){this.toggle(!0)}},{key:"hide",value:function(){this.toggle()}},{key:"toggle",value:function(e){var t=this.el.getAttribute("data-initialdisplay"),s=this.el.style.display,n=(window.getComputedStyle?getComputedStyle(this.el,null):this.el.currentStyle).display;e?(t||"none"!==s||(this.el.style.display=""),""===this.el.style.display&&"none"===n&&(t=t||defaultDisplay(this.el.nodeName))):(s&&"none"!==s||"none"!==n)&&this.el.setAttribute("data-initialdisplay","none"===n?s:n),e&&"none"!==this.el.style.display&&""!==this.el.style.display||(this.el.style.display=e?t||"":"none")}}],[{key:"create",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"",i=document.createElement(e);if(t)try{i.className=t.join(" ")}catch(e){"string"==typeof t&&(i.className=t)}if(s)for(var o in s)s.hasOwnProperty(o)&&i.setAttribute(o,s[o]);return n&&(i.innerHTML=n),i}}]),s}();return function(){function n(e,i,o){var r=this,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},u=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[];t(this,n);var l="string"==typeof(new XMLHttpRequest).responseType&&"withCredentials"in new XMLHttpRequest;if(l){var p=new XMLHttpRequest;p.open("GET","/");try{p.responseType="arraybuffer"}catch(e){l=!1}}var d,h={abortable:!0,acceptTypes:[],acceptExtensions:[],counter:!0,debug:!1,dragdrop:null,dragdrophoverclass:"twistupload-drop-hover",hideInput:!1,invalidtypemessage:"This file type is not permitted",multiple:!1,onabort:function(){},onclear:function(){},oncompletefile:function(){},oncompletequeue:function(){},onerror:function(){},oninvalidtype:function(){},onprogress:function(){},onstart:function(){},previewsize:128,previewsquare:!0};for(var c in this.settings={},h)this.settings[c]=a[c]||h[c];this.id=e,this.elements={CancelUpload:s.create("button","",{},"Cancel"),Count:s.create("span"),CountTotal:s.create("span"),CountWrapper:s.create("span"),Input:s.create("input","",(d={type:"file",accept:r.settings.acceptTypes.concat(r.settings.acceptExtensions).join(",")},r.settings.multiple&&(d.multiple="multiple"),d)),List:s.create("ul","twistupload-file-list"),Progress:s.create("progress","",{value:"0",max:"100"}),ProgressWrapper:s.create("span"),Pseudo:s.create("input","",{type:"hidden",name:o,value:this.settings.value}),Wrapper:document.getElementById(e)},this.events={},this.queue=[],this.queueCount=0,this.queueSize=0,this.queueUploadedCount=0,this.queueUploadedSize=0,this.request=new XMLHttpRequest,this.uploaded=u,this.uri="/"+i.replace(/^\//,"").replace(/\/$/,""),this.addMarkup(),this.addDragAndDropListeners(),l?(this.elements.Input.addEventListener("change",function(e,t){r.upload(e,t)}),this.updateUploadedList()):(this.hideProgress(),console.warn("Browser does not support AJAX uploading"))}return e(n,[{key:"addMarkup",value:function(){this.elements.ProgressWrapper.appendChild(this.elements.Progress),this.elements.ProgressWrapper.appendChild(this.elements.CancelUpload),this.settings.multiple&&(this.elements.CountWrapper.appendChild(this.elements.Count),this.elements.CountWrapper.insertAdjacentHTML("beforeend","/"),this.elements.CountWrapper.appendChild(this.elements.CountTotal),this.elements.ProgressWrapper.appendChild(this.elements.CountWrapper)),this.elements.Wrapper.appendChild(this.elements.Input),this.elements.Wrapper.appendChild(this.elements.Pseudo),this.elements.Wrapper.appendChild(this.elements.ProgressWrapper),this.elements.Wrapper.appendChild(this.elements.List),this.settings.hideInput&&new s(this.elements.Input).hide(),this.hideProgress()}},{key:"addDragAndDropListeners",value:function(){var e=this,t=this.elements.Wrapper,s=this.settings.dragdrop?document.querySelectorAll(this.settings.dragdrop):[];s.length&&(t=s[0]),t.addEventListener("dragover",function(s){s.stopPropagation(),s.preventDefault(),console.log("DRAG OVER"),t.classList.add(e.settings.dragdrophoverclass)},!1),t.addEventListener("dragleave",function(s){s.stopPropagation(),s.preventDefault(),console.log("DRAG LEAVE"),t.classList.remove(e.settings.dragdrophoverclass)},!1),t.addEventListener("drop",function(s){s.stopPropagation(),s.preventDefault(),e.upload(s,s.target.files||s.dataTransfer.files),t.classList.remove(e.settings.dragdrophoverclass)},!1)}},{key:"upload",value:function(e,t){var n=this;try{if(e){var i=t||(e.target||e.srcElement).files;this.queue.push.apply(this.queue,i),this.queueCount+=i.length;for(var o=0,r=i.length;o<r;o++)this.queueSize+=parseInt(i[o].size);this.elements.CountTotal&&(this.elements.CountTotal.innerText=this.queueCount)}if(this.queue.length){var a=this.queue[0],u=a.name,l=a.type,p=u.substr(u.lastIndexOf(".")+1).toLowerCase(),d=parseInt(a.size),h=new FileReader({blob:!0}),c=!this.settings.acceptTypes.length&&!this.settings.acceptExtensions.length;if(!c)for(var g in this.settings.acceptTypes){var f=this.settings.acceptTypes[g];if(new RegExp("^"+f.replace("*",".*")+"$","gi").test(l)){c=!0;break}}if(!c)for(var v in-1!==this.settings.acceptExtensions.indexOf("."+p)&&(c=!0),this.settings.acceptExtensions){if(p===this.settings.acceptExtensions[v]){c=!0;break}}if(c)this.settings.onstart(a),this.showProgress(),this.elements.Count&&(this.elements.Count.innerText=this.queueUploadedCount+1),1===this.queueCount?(this.elements.Progress&&this.elements.Progress.removeAttribute("value"),new s(this.elements.CountWrapper).hide()):this.elements.CountWrapper&&new s(this.elements.CountWrapper).show(),h.addEventListener("load",function(e){n.request.onreadystatechange=function(){switch(n.request.status){case 200:if(4===n.request.readyState){n.queue.shift(),n.queueUploadedCount++,n.queueUploadedSize+=d;var e=JSON.parse(n.request.responseText);n.queue.length?(n.settings.multiple?n.uploaded.push(e):n.uploaded=[e.form_value],n.updateUploadedList(),window.twist&&window.twist.debug&&window.twist.debug.logFileUpload(a,e),n.settings.oncompletefile(e,a),n.upload()):(n.hideProgress(),n.queueCount=0,n.queueSize=0,n.queueUploadedCount=0,n.queueUploadedSize=0,n.clearInput(),n.settings.multiple?n.uploaded.push(e):n.uploaded=[e],n.updateUploadedList(),window.twist&&window.twist.debug&&window.twist.debug.logFileUpload(a,e),n.settings.oncompletefile(e,a),n.settings.oncompletequeue())}break;case 403:console.error("Permission denied"),n.queue.shift(),n.queueCount--,n.queueSize--,n.settings.onerror(a),n.queue.length?n.upload():n.hideProgress();break;case 404:console.error("Invalid function call"),n.queue.shift(),n.queueCount--,n.queueSize--,n.settings.onerror(a),n.queue.length?n.upload():n.hideProgress()}},n.request.onprogress=function(e){if(e.lengthComputable){if(n.elements.Progress){var t=Math.round(e.loaded/e.total*100);n.elements.Progress.value=t}n.settings.onprogress(a,e.loaded,e.total)}},n.request.upload.onprogress=n.request.onprogress,n.request.addEventListener("load",function(){},!1),n.request.addEventListener("error",function(){n.queue.length&&(n.hideProgress(),n.queue=[],n.queueCount=0,n.queueSize=0,n.queueUploadedCount=0,n.queueUploadedSize=0,n.settings.onerror(a),console.error("An error occurred"))},!1),n.request.addEventListener("abort",function(){n.queue.length&&(n.hideProgress(),n.queue=[],n.queueCount=0,n.queueSize=0,n.queueUploadedCount=0,n.queueUploadedSize=0,n.settings.onabort(a),console.warn("Upload aborted"))},!1),n.request.open("PUT",n.uri,!0),n.request.setRequestHeader("Accept",'"text/plain; charset=iso-8859-1", "Content-Type": "text/plain; charset=iso-8859-1"'),n.request.setRequestHeader("Twist-File",u),n.request.setRequestHeader("Twist-Length",d),n.request.setRequestHeader("Twist-UID",n.id),n.request.send(h.result)}),h.readAsArrayBuffer(a);else{var m=this.queue.shift();this.elements.Input.value="",this.settings.oninvalidtype(m,this.settings.acceptTypes,this.settings.acceptExtensions),console.error(u+" ("+l+") is not in the list of allowed types or extensions"),this.settings.acceptTypes.length&&console.info("Allowed MIME types: "+this.settings.acceptTypes.join(", ")),this.settings.acceptExtensions.length&&console.info("Allowed file extensions: "+this.settings.acceptExtensions.join(", ")),this.clearInput()}}}catch(e){this.hideProgress(),this.settings.onerror(this.queue[0]),this.settings.onabort(this.queue[0]),this.queue=[],this.queueCount=0,this.queueSize=0,this.queueUploadedCount=0,this.queueUploadedSize=0,console.error(e)}}},{key:"showProgress",value:function(){var e=this;new s(this.elements.Input).hide(),new s(this.elements.ProgressWrapper).show(),this.elements.CancelUpload&&this.elements.CancelUpload.addEventListener("click",function(){e.cancelUpload()})}},{key:"hideProgress",value:function(){var e=this;this.settings.hideInput||new s(this.elements.Input).show(),new s(this.elements.ProgressWrapper).hide(),this.elements.CancelUpload&&this.elements.CancelUpload.removeEventListener("click",function(){e.cancelUpload()})}},{key:"clearInput",value:function(){this.elements.Input.value="",this.elements.Input.value&&(this.elements.Input.type="text",this.elements.Input.type="file"),this.elements.Pseudo.value="",this.settings.onclear()}},{key:"cancelUpload",value:function(){this.request.abort(),this.clearInput()}},{key:"updateUploadedList",value:function(){var e=this,t=[];for(var n in this.elements.List.innerHTML="",console.log(this.uploaded),this.uploaded){var i=this.uploaded[n],o=i.uri_preview,r="",a=["file/name","file/size","file_type"],u="thumb-"+this.settings.previewsize;for(var l in t.push(i.form_value),this.settings.previewsquare&&(u="square-"+u),i.support&&i.support[u]&&(o=i.support[u]),a){var p=a[l],d=void 0;if(-1!==p.indexOf("/")){var h=p.split("/"),c=i[h[0]]||null;if(h.shift(),c){for(var g in h)c=c[h[g]]||null;d=c||null}}else d=i[p]||null;r+='<li data-key="'+p+'"><span>'+p.replace(/[\/_]/g," ")+" :</span>"+d+"</li>"}var f=s.create("li","twistupload-file-list-item"),v=s.create("img","",{src:o}),m=s.create("ul","twistupload-file-list-item-info",{},r),q=s.create("button","button",{},"Remove");q.addEventListener("click",function(t){return function(){e.uploaded.splice(e.uploaded.indexOf(t),1),e.updateUploadedList()}}(i)),f.appendChild(v),f.appendChild(m),f.appendChild(q),this.elements.List.appendChild(f)}this.elements.Pseudo.value=JSON.stringify(t)}},{key:"on",value:function(e,t){}},{key:"off",value:function(e,t){}},{key:"trigger",value:function(e){}}],[{key:"prettySize",value:function(e){for(var t=["B","kB","MB","GB","TB","PB","EB","ZB","YB"],s=0;t[s]&&e>Math.pow(1024,s+1);)s++;return this.round(e/Math.pow(1024,s),s>1?2:0)+t[s]}},{key:"round",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return 0===t?parseInt(Math.round(e*Math.pow(10,t))/Math.pow(10,t)):parseFloat(Math.round(e*Math.pow(10,t))/Math.pow(10,t))}}]),n}()});
//# sourceMappingURL=twistfileupload.js.map
